<!DOCTYPE html>
<html lang="uk" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>–ö–Ω–∏–≥–∞ –†–µ—Ü–µ–ø—Ç—ñ–≤ - PizzaGo</title>
    <link rel="stylesheet" th:href="@{/styles/client-styles.css}" />
    <link rel="stylesheet" th:href="@{/styles/admin.css}" />
    <style>
        /* –°—Ç–∏–ª—ñ –∫–∞—Ä—Ç–æ–∫ */
        .recipe-card {
            background: white; border-radius: 15px; padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px; border-left: 5px solid #193948;
            display: flex; justify-content: space-between; align-items: center;
        }
        .recipe-info h3 { margin: 0 0 5px 0; color: #193948; }
        .ingredients-preview { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 10px; }
        .ing-tag { background: #fff3cd; padding: 4px 10px; border-radius: 20px; font-size: 12px; color: #856404; }

        .btn-recipe {
            background: #fbbb54; color: #193948; padding: 10px 20px;
            border-radius: 8px; text-decoration: none; font-weight: bold;
            border: none; cursor: pointer; transition: 0.3s;
        }
        .btn-recipe:hover { background: #e0a800; transform: scale(1.05); }

        /* –ú–û–î–ê–õ–¨–ù–ï –í–Ü–ö–ù–û */
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 0; border-radius: 15px; width: 600px; position: relative; overflow: hidden;}
        .close { color: white; position: absolute; top: 15px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; z-index: 10;}

        /* –®–∞–ø–∫–∞ –º–æ–¥–∞–ª–∫–∏ (–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ —Å—Ç—Ä–∞–≤—É) */
        .modal-header {
            background: #193948; color: white; padding: 20px; display: flex; gap: 20px; align-items: center;
        }
        .modal-dish-img {
            width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid white; background: white;
        }
        .modal-dish-info h2 { margin: 0; font-size: 22px; }
        .modal-dish-info p { margin: 5px 0 0; opacity: 0.8; font-size: 14px; }

        /* –¢—ñ–ª–æ –º–æ–¥–∞–ª–∫–∏ */
        .modal-body { padding: 20px; }

        .recipe-editor-row { display: flex; gap: 10px; margin-bottom: 8px; padding: 10px; background: #f8f9fa; border-radius: 8px; align-items: center; }
        .ing-list { max-height: 250px; overflow-y: auto; margin-top: 15px; border: 1px solid #eee; padding: 10px; border-radius: 8px;}
    </style>
</head>
<body>

<header class="header">
    <div class="logo"><a th:href="@{/}"><img th:src="@{/images/Logo.svg}" alt="" /></a></div>
    <nav class="header-navigation">
        <a th:href="@{/admin-crud}">–¢–æ–≤–∞—Ä–∏</a>
        <a th:href="@{/admin/orders}">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</a>
        <a th:href="@{/admin/cars}">–ê–≤—Ç–æ–ø–∞—Ä–∫</a>
        <a th:href="@{/admin/ingredients}">–°–∫–ª–∞–¥</a>
        <a th:href="@{/admin/recipes}" style="font-weight: bold; color: #6a4821;">–†–µ—Ü–µ–ø—Ç–∏</a>
        <a th:href="@{/admin/stats}">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
    </nav>
    <div class="header-user-actions">
        <a style="font-weight: bold; cursor:pointer;" onclick="handleUserClick(event)">–ê–¥–º—ñ–Ω</a>
        <a href="#" onclick="logout()" style="color: red; margin-left: 15px;">–í–∏—Ö—ñ–¥</a>
    </div>
</header>

<main class="conteiner" style="display: block;">
    <h2 style="margin: 30px 0;">üìö –ö–Ω–∏–≥–∞ –†–µ—Ü–µ–ø—Ç—ñ–≤</h2>

    <div th:each="product : ${products}" class="recipe-card">
        <div class="recipe-info">
            <h3 th:text="${product.name}">–ú–∞—Ä–≥–∞—Ä–∏—Ç–∞</h3>
            <span style="font-size: 12px; color: #888;" th:text="${product.category}">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</span>

            <div class="ingredients-preview">
                <span th:if="${#lists.isEmpty(product.recipes)}" style="color: #dc3545; font-weight: bold; font-size: 12px;">
                    ‚ö†Ô∏è –†–µ—Ü–µ–ø—Ç –≤—ñ–¥—Å—É—Ç–Ω—ñ–π
                </span>

                <span class="ing-tag" th:each="rec : ${product.recipes}"
                      th:if="${rec.ingredient != null}"
                      th:text="${rec.ingredient.name} + ': ' + ${rec.amount.stripTrailingZeros().toPlainString()} + ' ' + (${rec.ingredient.unitOfMeasure} ?: '')"
                </span>
            </div>
        </div>

        <button class="btn-recipe"
                th:data-id="${product.id}"
                th:data-name="${product.name}"
                th:data-price="${product.price}"
                th:data-img="${product.imageUrl}"
                th:data-cat="${product.category}"
                onclick="openRecipeEditor(this)">
            üìù –†–µ–¥–∞–≥—É–≤–∞—Ç–∏
        </button>
    </div>
</main>

<div id="recipeModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>

        <div class="modal-header">
            <img id="modalImg" src="" alt="–°—Ç—Ä–∞–≤–∞" class="modal-dish-img" onerror="this.src='/images/Logo.svg'"> <div class="modal-dish-info">
            <h2 id="modalDishName">–ù–∞–∑–≤–∞ —Å—Ç—Ä–∞–≤–∏</h2>
            <p>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: <span id="modalCat">–ü—ñ—Ü–∞</span> | –¶—ñ–Ω–∞: <span id="modalPrice">0</span> –≥—Ä–Ω</p>
        </div>
        </div>

        <div class="modal-body">
            <input type="hidden" id="currentProductId">

            <div style="background: #e3f2fd; padding: 15px; border-radius: 10px;">
                <label style="font-weight: bold; font-size: 14px; margin-bottom: 5px; display:block;">–î–æ–¥–∞—Ç–∏ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç:</label>
                <div style="display: flex; gap: 10px;">
                    <select id="newIngSelect" style="flex: 2; padding: 10px; border-radius: 8px; border: 1px solid #ccc;">
                        <option value="">-- –û–±–µ—Ä—ñ—Ç—å –∑—ñ —Å–∫–ª–∞–¥—É --</option>
                        <option th:each="ing : ${ingredients}"
                                th:value="${ing.id}"
                                th:data-unit="${ing.unitOfMeasure}"
                                th:text="${ing.name} + ' (' + ${ing.unitOfMeasure} + ')'">
                        </option>
                    </select>
                    <input type="number" id="newIngAmount" step="0.001" placeholder="–ö-—Å—Ç—å" style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ccc;">
                    <button onclick="addIngredientToRecipe()" style="background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 50px; font-size: 20px;">+</button>
                </div>
            </div>

            <h4 style="margin-top: 20px; color: #193948;">–ü–æ—Ç–æ—á–Ω–∏–π —Å–∫–ª–∞–¥:</h4>
            <div id="modalIngredientsList" class="ing-list"></div>

            <div style="margin-top: 20px; text-align: right;">
                <button onclick="saveRecipeChanges()" class="btn-recipe" style="width: 100%;">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏</button>
            </div>
        </div>
    </div>
</div>

<script th:src="@{/js/client.js}"></script>
<script th:src="@{/js/admin.js}"></script>

<script>
    let currentRecipe = [];

    // 1. –í–Ü–î–ö–†–ò–¢–¢–Ø (–û—Ç—Ä–∏–º—É—î–º–æ –∫–Ω–æ–ø–∫—É —è–∫ –∞—Ä–≥—É–º–µ–Ω—Ç)
    async function openRecipeEditor(btn) {
        // –ß–∏—Ç–∞—î–º–æ –¥–∞–Ω—ñ –∑ –∞—Ç—Ä–∏–±—É—Ç—ñ–≤ –∫–Ω–æ–ø–∫–∏
        const id = btn.getAttribute('data-id');
        const name = btn.getAttribute('data-name');
        const price = btn.getAttribute('data-price');
        const cat = btn.getAttribute('data-cat');
        const img = btn.getAttribute('data-img');

        // –ó–∞–ø–æ–≤–Ω—é—î–º–æ —à–∞–ø–∫—É –º–æ–¥–∞–ª–∫–∏
        document.getElementById('currentProductId').value = id;
        document.getElementById('modalDishName').innerText = name;
        document.getElementById('modalPrice').innerText = price;
        document.getElementById('modalCat').innerText = cat;
        document.getElementById('modalImg').src = img || '/images/Logo.svg'; // –Ø–∫—â–æ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –Ω–µ–º–∞

        document.getElementById('recipeModal').style.display = 'block';

        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ä–µ—Ü–µ–ø—Ç
        try {
            const response = await fetch('/api/recipes/pizza/' + id);
            if (response.ok) {
                const data = await response.json();
                currentRecipe = data.map(item => ({
                    ingredientId: item.ingredient.id,
                    name: item.ingredient.name,
                    unit: item.ingredient.unitOfMeasure,
                    amount: item.amount
                }));
            } else {
                currentRecipe = [];
            }
            renderEditorList();
        } catch (e) {
            console.error(e);
            currentRecipe = [];
            renderEditorList();
        }
    }

    // 2. –î–û–î–ê–í–ê–ù–ù–Ø (–õ–æ–∫–∞–ª—å–Ω–æ)
    function addIngredientToRecipe() {
        const select = document.getElementById('newIngSelect');
        const amountInput = document.getElementById('newIngAmount');
        const id = select.value;
        const amount = parseFloat(amountInput.value);

        if(!id || !amount) { alert("–û–±–µ—Ä—ñ—Ç—å —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç —ñ –∫—ñ–ª—å–∫—ñ—Å—Ç—å!"); return; }

        const option = select.options[select.selectedIndex];
        const name = option.text.split(' (')[0];
        const unit = option.getAttribute('data-unit');

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ—Å–Ω—É—é—á–æ–≥–æ
        const existing = currentRecipe.find(r => r.ingredientId == id);
        if(existing) {
            existing.amount = amount;
        } else {
            currentRecipe.push({ ingredientId: id, name: name, unit: unit, amount: amount });
        }

        renderEditorList();
        select.value = ""; amountInput.value = "";
    }

    // 3. –†–ï–ù–î–ï–†
    function renderEditorList() {
        const container = document.getElementById('modalIngredientsList');
        container.innerHTML = '';

        if(currentRecipe.length === 0) {
            container.innerHTML = '<p style="color:gray; text-align:center; padding: 20px;">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç–∏–π. –î–æ–¥–∞–π—Ç–µ —â–æ—Å—å –∑–≤–µ—Ä—Ö—É ‚òùÔ∏è</p>';
            return;
        }

        currentRecipe.forEach((item, index) => {
            container.innerHTML += `
                <div class="recipe-editor-row">
                    <span style="flex: 2; font-weight: bold;">${item.name}</span>
                    <span style="flex: 1; text-align: center;">${parseFloat(item.amount)} ${item.unit || ''}</span>
                    <button onclick="removeFromRecipe(${index})" style="background: #ffdddd; color: #d9534f; border: 1px solid #d9534f; padding: 5px 10px; border-radius: 5px; cursor: pointer;">üóëÔ∏è</button>
                </div>
            `;
        });
    }

    function removeFromRecipe(index) {
        currentRecipe.splice(index, 1);
        renderEditorList();
    }

    async function saveRecipeChanges() {
        const productId = document.getElementById('currentProductId').value;
        try {
            for (const item of currentRecipe) {
                const recipeData = {
                    // –í–∞–∂–ª–∏–≤–æ: –º–∏ –ø–µ—Ä–µ–¥–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ IDs –¥–ª—è –∑–≤'—è–∑–∫—É
                    pizza: { id: productId },
                    ingredient: { id: item.ingredientId },
                    amount: item.amount
                };

                const response = await fetch('/api/recipes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(recipeData)
                });

                // üëá –û–°–¨ –¶–¨–û–ì–û –ù–ï –í–ò–°–¢–ê–ß–ê–õ–û:
                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error('–°–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ –ø–æ–º–∏–ª–∫—É: ' + errText);
                }
            }
            alert('–†–µ—Ü–µ–ø—Ç —É—Å–ø—ñ—à–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤ –±–∞–∑—ñ!');
            location.reload();
        } catch (e) {
            console.error(e);
            alert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: ' + e.message);
        }
    }

    function closeModal() {
        document.getElementById('recipeModal').style.display = 'none';
    }
</script>

</body>
</html>